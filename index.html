<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Tạo Hình Ảnh AI</title>
    <!-- Thư viện Tailwind CSS để tạo giao diện đẹp và tương thích di động -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thư viện Icon Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2gS6iT3P0/BfL3Q74i5wV2u54wQeN5T15t5Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Thư viện Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Biến toàn cục từ môi trường Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(__firebase_config);
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Khởi tạo Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Biến toàn cục để lưu userId
        let userId = null;
        let isAuthReady = false;

        // Xử lý xác thực người dùng
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
            } else {
                try {
                    // Nếu không có token, đăng nhập ẩn danh
                    if (!initialAuthToken) {
                        await signInAnonymously(auth);
                    } else {
                        await signInWithCustomToken(auth, initialAuthToken);
                    }
                    userId = auth.currentUser.uid;
                } catch (error) {
                    console.error("Lỗi xác thực người dùng:", error);
                }
            }
            isAuthReady = true;
        });

        window.firebaseApp = {
            db,
            auth,
            getUserId: () => userId,
            isAuthReady: () => isAuthReady
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="p-4 bg-gray-100 flex flex-col items-center justify-center min-h-screen">

    <!-- Container chính của ứng dụng -->
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-3xl w-full mb-8">
        <!-- Ngôn ngữ và tiêu đề -->
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800" data-lang-key="title">
                <i class="fa-solid fa-sparkles text-blue-500 mr-2"></i>Tạo Hình Ảnh AI
            </h1>
            <select id="language-select" class="p-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="vi" selected>Tiếng Việt</option>
                <option value="en">English</option>
            </select>
        </div>

        <p class="text-center text-gray-600 mb-6" data-lang-key="description">
            Nhập mô tả, chọn phong cách và tỷ lệ khung hình để tạo hình ảnh.
        </p>

        <!-- Ô nhập liệu cho prompt -->
        <textarea id="prompt-input" rows="4" class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 mb-4 text-gray-700" placeholder="Ví dụ: Một chú mèo phi hành gia đang bay trong vũ trụ, phong cách hoạt hình"></textarea>
        
        <!-- Các tùy chọn nâng cao -->
        <div class="flex flex-col sm:flex-row gap-4 mb-4">
            <!-- Chọn phong cách -->
            <div class="flex-1">
                <label for="style-select" class="block text-gray-700 font-semibold mb-2" data-lang-key="styleLabel">
                    <i class="fa-solid fa-palette text-gray-500 mr-2"></i>Phong cách
                </label>
                <select id="style-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="" data-lang-key="defaultStyle" selected>Mặc định</option>
                    <option value=", phong cách hoạt hình" data-lang-key="cartoonStyle">Hoạt hình</option>
                    <option value=", phong cách sơn dầu" data-lang-key="oilPaintingStyle">Sơn dầu</option>
                    <option value=", phong cách nhiếp ảnh thực tế" data-lang-key="realisticStyle">Nhiếp ảnh thực tế</option>
                    <option value=", phong cách nghệ thuật kỹ thuật số" data-lang-key="digitalArtStyle">Nghệ thuật số</option>
                    <option value=", phong cách vẽ chì" data-lang-key="pencilDrawingStyle">Vẽ chì</option>
                </select>
            </div>

            <!-- Chọn tỷ lệ khung hình -->
            <div class="flex-1">
                <label for="aspect-ratio-select" class="block text-gray-700 font-semibold mb-2" data-lang-key="aspectRatioLabel">
                    <i class="fa-solid fa-crop-simple text-gray-500 mr-2"></i>Tỷ lệ khung hình
                </label>
                <select id="aspect-ratio-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="1:1" selected>1:1 (Hình vuông)</option>
                    <option value="16:9">16:9 (YouTube)</option>
                    <option value="9:16">9:16 (TikTok)</option>
                </select>
            </div>
        </div>

        <!-- Nút để kích hoạt việc tạo hình ảnh -->
        <button id="generate-button" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ease-in-out">
            <i class="fa-solid fa-magic-wand-sparkles mr-2"></i><span data-lang-key="generateButton">Tạo Hình Ảnh</span>
        </button>

        <!-- Khu vực hiển thị hình ảnh và trạng thái -->
        <div id="image-container" class="mt-8 flex flex-col items-center">
            <div id="loading-spinner" class="hidden">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent"></div>
                <p class="mt-4 text-gray-500" data-lang-key="loadingMessage">Đang tạo hình ảnh...</p>
            </div>
            
            <img id="generated-image" class="hidden w-full h-auto rounded-lg shadow-lg" alt="Hình ảnh được tạo bởi AI">

            <a id="download-link" class="hidden mt-4 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300 ease-in-out" download="ai-image.png">
                <i class="fa-solid fa-download mr-2"></i><span data-lang-key="downloadButton">Tải Xuống</span>
            </a>

            <!-- Khu vực hiển thị lỗi -->
            <div id="error-message" class="hidden mt-4 text-red-500 text-center"></div>
        </div>
    </div>
    
    <!-- Phần hiển thị lịch sử -->
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-3xl w-full">
        <h2 class="text-2xl font-bold mb-4 text-gray-800" data-lang-key="historyTitle">
            <i class="fa-solid fa-clock-rotate-left text-gray-500 mr-2"></i>Lịch Sử Hình Ảnh
        </h2>
        <!-- Lưới hiển thị lịch sử hình ảnh. -->
        <div id="history-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
            <p class="text-gray-500 text-center col-span-full" id="history-empty-message" data-lang-key="historyEmpty">Lịch sử trống.</p>
        </div>
    </div>

    <!-- Thông tin bản quyền -->
    <footer class="mt-8 text-center text-gray-500 text-sm">
        <p data-lang-key="copyrightText">© 2024 AI Image Generator. Mọi quyền được bảo lưu.</p>
    </footer>

    <script>
        // Lấy các phần tử DOM cần thiết
        const languageSelect = document.getElementById('language-select');
        const promptInput = document.getElementById('prompt-input');
        const styleSelect = document.getElementById('style-select');
        const aspectRatioSelect = document.getElementById('aspect-ratio-select');
        const generateButton = document.getElementById('generate-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const generatedImage = document.getElementById('generated-image');
        const downloadLink = document.getElementById('download-link');
        const errorMessage = document.getElementById('error-message');
        const historyContainer = document.getElementById('history-container');
        const historyEmptyMessage = document.getElementById('history-empty-message');

        // Đối tượng chứa các bản dịch
        const translations = {
            'vi': {
                title: 'Tạo Hình Ảnh AI',
                description: 'Nhập mô tả, chọn phong cách và tỷ lệ khung hình để tạo hình ảnh.',
                promptPlaceholder: 'Ví dụ: Một chú mèo phi hành gia đang bay trong vũ trụ, phong cách hoạt hình',
                styleLabel: 'Phong cách',
                defaultStyle: 'Mặc định',
                cartoonStyle: 'Hoạt hình',
                oilPaintingStyle: 'Sơn dầu',
                realisticStyle: 'Nhiếp ảnh thực tế',
                digitalArtStyle: 'Nghệ thuật số',
                pencilDrawingStyle: 'Vẽ chì',
                aspectRatioLabel: 'Tỷ lệ khung hình',
                generateButton: 'Tạo Hình Ảnh',
                loadingMessage: 'Đang tạo hình ảnh...',
                downloadButton: 'Tải Xuống',
                errorPrompt: 'Vui lòng nhập mô tả để tạo hình ảnh.',
                errorApi: 'Không thể tạo hình ảnh:',
                errorHistory: 'Không thể lưu lịch sử hình ảnh.',
                historyTitle: 'Lịch Sử Hình Ảnh',
                historyEmpty: 'Lịch sử trống.',
                copyrightText: '© 2024 AI Image Generator. Mọi quyền được bảo lưu.',
                creatingText: 'Đang tạo...'
            },
            'en': {
                title: 'AI Image Generator',
                description: 'Enter a description, choose a style and aspect ratio to generate an image.',
                promptPlaceholder: 'Example: An astronaut cat flying in space, cartoon style',
                styleLabel: 'Style',
                defaultStyle: 'Default',
                cartoonStyle: 'Cartoon',
                oilPaintingStyle: 'Oil Painting',
                realisticStyle: 'Realistic Photo',
                digitalArtStyle: 'Digital Art',
                pencilDrawingStyle: 'Pencil Drawing',
                aspectRatioLabel: 'Aspect Ratio',
                generateButton: 'Generate Image',
                loadingMessage: 'Generating image...',
                downloadButton: 'Download',
                errorPrompt: 'Please enter a description to generate an image.',
                errorApi: 'Failed to generate image:',
                errorHistory: 'Failed to save image history.',
                historyTitle: 'Image History',
                historyEmpty: 'History is empty.',
                copyrightText: '© 2024 AI Image Generator. All rights reserved.',
                creatingText: 'Generating...'
            }
        };

        // Hàm cập nhật ngôn ngữ trên toàn bộ ứng dụng
        function updateLanguage(lang) {
            const elements = document.querySelectorAll('[data-lang-key]');
            elements.forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (key) {
                    el.textContent = translations[lang][key];
                }
            });

            // Cập nhật placeholder và text cho nút
            promptInput.placeholder = translations[lang].promptPlaceholder;
            if (generateButton.disabled) {
                generateButton.textContent = translations[lang].creatingText;
            } else {
                generateButton.innerHTML = `<i class="fa-solid fa-magic-wand-sparkles mr-2"></i><span>${translations[lang].generateButton}</span>`;
            }
            if (downloadLink.classList.contains('hidden')) {
                // Không làm gì nếu nút tải xuống đang ẩn
            } else {
                downloadLink.innerHTML = `<i class="fa-solid fa-download mr-2"></i><span>${translations[lang].downloadButton}</span>`;
            }

            // Cập nhật các option trong select box
            const styleOptions = styleSelect.querySelectorAll('option');
            styleOptions[0].textContent = translations[lang].defaultStyle;
            styleOptions[1].textContent = translations[lang].cartoonStyle;
            styleOptions[2].textContent = translations[lang].oilPaintingStyle;
            styleOptions[3].textContent = translations[lang].realisticStyle;
            styleOptions[4].textContent = translations[lang].digitalArtStyle;
            styleOptions[5].textContent = translations[lang].pencilDrawingStyle;
        }

        // Lắng nghe sự kiện thay đổi ngôn ngữ
        languageSelect.addEventListener('change', (e) => {
            updateLanguage(e.target.value);
        });

        // Lắng nghe trạng thái xác thực Firebase và tải lịch sử
        window.addEventListener('load', () => {
            updateLanguage('vi'); // Cập nhật ngôn ngữ mặc định là tiếng Việt khi tải trang
            const checkAuthAndLoad = setInterval(() => {
                if (window.firebaseApp && window.firebaseApp.isAuthReady()) {
                    clearInterval(checkAuthAndLoad);
                    setupHistoryListener();
                }
            }, 100);
        });

        // Thiết lập listener cho lịch sử hình ảnh trong Firestore
        function setupHistoryListener() {
            const db = window.firebaseApp.db;
            const userId = window.firebaseApp.getUserId();
            if (!userId) return;

            const historyRef = collection(db, `artifacts/${appId}/users/${userId}/image_history`);
            const q = query(historyRef, orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                historyContainer.innerHTML = '';
                if (snapshot.empty) {
                    historyEmptyMessage.classList.remove('hidden');
                } else {
                    historyEmptyMessage.classList.add('hidden');
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        renderHistoryItem(data);
                    });
                }
            });
        }

        // Tạo và hiển thị một mục lịch sử
        function renderHistoryItem(data) {
            const container = document.createElement('div');
            container.className = 'relative group cursor-pointer';

            const img = document.createElement('img');
            img.src = data.imageData;
            img.alt = data.prompt;
            img.className = 'w-full h-32 object-cover rounded-lg transition-transform transform group-hover:scale-105';

            const overlay = document.createElement('div');
            overlay.className = 'absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity rounded-lg';
            
            const promptText = document.createElement('p');
            promptText.className = 'text-white text-xs p-2 text-center';
            promptText.textContent = data.prompt;

            overlay.appendChild(promptText);
            container.appendChild(img);
            container.appendChild(overlay);

            historyContainer.appendChild(container);
        }

        // Hàm lưu hình ảnh vào Firestore
        async function saveImageToHistory(prompt, imageData, style, aspectRatio) {
            const db = window.firebaseApp.db;
            const userId = window.firebaseApp.getUserId();
            if (!userId) {
                console.error("Không thể lưu lịch sử: userId không xác định.");
                return;
            }

            const historyRef = collection(db, `artifacts/${appId}/users/${userId}/image_history`);
            try {
                await setDoc(doc(historyRef), {
                    prompt,
                    imageData,
                    style,
                    aspectRatio,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                console.error("Lỗi khi thêm tài liệu vào Firestore: ", e);
                errorMessage.textContent = translations[languageSelect.value].errorHistory;
                errorMessage.classList.remove('hidden');
            }
        }
        
        // Hàm để resize/crop hình ảnh bằng Canvas
        function resizeImage(base64, aspectRatio) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    const [targetWidthRatio, targetHeightRatio] = aspectRatio.split(':').map(Number);
                    
                    let newWidth, newHeight, x = 0, y = 0;
                    
                    const imageAspectRatio = img.width / img.height;
                    const targetAspectRatio = targetWidthRatio / targetHeightRatio;

                    if (imageAspectRatio > targetAspectRatio) {
                        newHeight = img.height;
                        newWidth = img.height * targetAspectRatio;
                        x = (img.width - newWidth) / 2;
                    } else {
                        newWidth = img.width;
                        newHeight = img.width / targetAspectRatio;
                        y = (img.height - newHeight) / 2;
                    }

                    canvas.width = newWidth;
                    canvas.height = newHeight;

                    ctx.drawImage(img, x, y, newWidth, newHeight, 0, 0, newWidth, newHeight);

                    resolve(canvas.toDataURL('image/png'));
                };
                img.src = base64;
            });
        }

        // Thêm trình lắng nghe sự kiện cho nút Tạo Hình Ảnh
        generateButton.addEventListener('click', async () => {
            let prompt = promptInput.value.trim();
            const selectedStyle = styleSelect.value;
            const selectedAspectRatio = aspectRatioSelect.value;
            const lang = languageSelect.value;

            if (!prompt) {
                errorMessage.textContent = translations[lang].errorPrompt;
                errorMessage.classList.remove('hidden');
                return;
            }

            // Gắn phong cách vào prompt
            if (selectedStyle) {
                prompt += selectedStyle;
            }

            // Ẩn các phần tử trước đó và hiển thị spinner
            generatedImage.classList.add('hidden');
            downloadLink.classList.add('hidden');
            errorMessage.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            generateButton.disabled = true;
            generateButton.innerHTML = `<i class="fa-solid fa-magic-wand-sparkles mr-2"></i><span data-lang-key="creatingText">${translations[lang].creatingText}</span>`;

            let retryCount = 0;
            const maxRetries = 3;
            const initialDelay = 1000;

            const fetchWithRetry = async () => {
                const payload = { 
                    instances: { prompt: prompt }, 
                    parameters: { "sampleCount": 1 } 
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < maxRetries) {
                            const delay = initialDelay * Math.pow(2, retryCount);
                            console.log(`Rate limit exceeded. Retrying in ${delay}ms...`);
                            await new Promise(resolve => setTimeout(resolve, delay));
                            retryCount++;
                            return await fetchWithRetry();
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }

                    const result = await response.json();

                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        const originalImageUrl = `data:image/png;base64,${base64Data}`;
                        
                        // Resize/crop hình ảnh dựa trên tỷ lệ khung hình đã chọn
                        const resizedImageUrl = await resizeImage(originalImageUrl, selectedAspectRatio);
                        
                        generatedImage.src = resizedImageUrl;
                        generatedImage.classList.remove('hidden');
                        downloadLink.href = resizedImageUrl;
                        downloadLink.classList.remove('hidden');
                        downloadLink.innerHTML = `<i class="fa-solid fa-download mr-2"></i><span data-lang-key="downloadButton">${translations[lang].downloadButton}</span>`;
                        
                        // Lưu hình ảnh vào lịch sử
                        await saveImageToHistory(prompt, resizedImageUrl, selectedStyle, selectedAspectRatio);
                    } else {
                        throw new Error('API response did not contain a valid image.');
                    }
                } catch (error) {
                    console.error('Error generating image:', error);
                    errorMessage.textContent = `${translations[lang].errorApi} ${error.message}`;
                    errorMessage.classList.remove('hidden');
                } finally {
                    loadingSpinner.classList.add('hidden');
                    generateButton.disabled = false;
                    generateButton.innerHTML = `<i class="fa-solid fa-magic-wand-sparkles mr-2"></i><span data-lang-key="generateButton">${translations[lang].generateButton}</span>`;
                }
            };
            
            fetchWithRetry();
        });
    </script>
</body>
</html>

